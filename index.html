<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Cryptogram ‚Äì beta</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/vapor/bootstrap.min.css" rel="stylesheet"/>

<style>
    body{
        min-height:100vh;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        padding-top:90px;          /* spa»õiu sub navbar-ul fix */
        padding-bottom:20px;
    }
    .container{max-width:960px;}
    .captcha-img{width:100%;display:block;margin-bottom:.5rem;}
    textarea.mnemonic{font-family:monospace;user-select:all;height:90px;}
    #chat-list{overflow-y:auto;max-height:60vh;}
    #chat-msgs{max-height:60vh;overflow-y:auto;display:flex;flex-direction:column;padding:1rem;}
    #chat-msgs .me{align-self:flex-end;text-align:right;}
    #chat-msgs .peer{align-self:flex-start;text-align:left;}
    #chat-msgs .message-bubble{padding:.5rem .75rem;border-radius:.75rem;margin-bottom:.5rem;max-width:85%;word-wrap:break-word;display:inline-block;}
    #chat-msgs .me .message-bubble{background-color:#007bff;color:#fff;}
    #chat-msgs .peer .message-bubble{background-color:#6c757d;color:#fff;}
    #chat-msgs .message-sender{font-size:.8em;opacity:.8;margin-bottom:.2rem;display:block;}
    .is-valid{border-color:#28a745!important;}
    .is-invalid{border-color:#dc3545!important;}
    #toast-container{z-index:1080;}
</style>
</head>

<body class="container py-5">

<!--  NAVBAR  -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Cryptogram</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav" aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="topNav">
            <!--  c√¢nd NU e»ôti logat  -->
            <ul class="navbar-nav ms-auto" id="nav-auth">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="navLoginLink">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="navRegLink">Register</a>
                </li>
            </ul>

            <!--  c√¢nd E»òTI logat  -->
            <ul class="navbar-nav ms-auto d-none" id="nav-user">
                <li class="nav-item d-flex align-items-center gap-2">
                    <span class="navbar-text" id="nav-username"></span>
                    <button class="btn btn-outline-light btn-sm" id="btn-share" data-bs-toggle="modal" data-bs-target="#shareModal">Share</button>
                    <button class="btn btn-danger btn-sm" id="nav-logout">Logout</button>
                </li>
            </ul>
        </div>
    </div>
</nav>
<!--  /NAVBAR  -->

<h1 class="text-center mb-4 d-none d-lg-block">Cryptogram <small>beta</small></h1>

<div id="auth-wrap">
    <ul class="nav nav-tabs justify-content-center mb-4" id="auth-tabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-log" role="tab">Login</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reg" role="tab">Register</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active p-4" id="tab-log">
            <div class="card p-4 mx-auto shadow" style="max-width:420px">
                <h4 class="mb-3">Login</h4>
                <img id="cap-img-log" class="captcha-img border rounded" alt="Captcha">
                <input id="cap-inp-log" class="form-control mb-2" placeholder="Enter captcha">
                <textarea id="extended-inp" class="form-control mb-2" placeholder="Extended token (Base64 JSON)"></textarea>
                <button id="btn-log" class="btn btn-primary w-100">Login ‚ñ∂Ô∏é</button>
                <div id="log-msg" class="mt-3 small"></div>
            </div>
        </div>

        <div class="tab-pane fade p-4" id="tab-reg">
            <div class="card p-4 mx-auto shadow" style="max-width:420px">
                <h4 class="mb-3">Create account</h4>
                <img id="cap-img-reg" class="captcha-img border rounded" alt="Captcha">
                <input id="cap-inp-reg" class="form-control mb-2" placeholder="Enter captcha">
                <button id="btn-reg" class="btn btn-success w-100">Create üîê</button>
                <div id="reg-msg" class="mt-3 small"></div>

                <div id="reg-sec" class="mt-3 d-none">
                    <label class="small">Extended token (save this!)</label>
                    <textarea id="extended-out" class="form-control mnemonic mb-2" readonly></textarea>
                    <button id="btn-reg-ok" class="btn btn-primary w-100">I saved it ‚úîÔ∏é</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="dash-wrap" class="d-none">
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-chat">Chat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inv">Invites</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-me">Profile</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-chat">
            <div class="d-flex mb-2">
                <button class="btn btn-outline-info ms-auto" data-bs-toggle="modal" data-bs-target="#inviteModal">Invite +</button>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <div id="chat-list" class="list-group">
                        <p class="small text-muted text-center">Loading chats...</p>
                    </div>
                </div>

                <div class="col-md-8">
                    <div id="chat-empty" class="border rounded p-5 text-center text-muted bg-dark">
                        <em>No chat open‚Ä¶</em>
                    </div>

                    <div id="chat-pane" class="d-none">
                        <div id="chat-msgs" class="border rounded bg-dark"></div>
                        <div class="input-group mt-2">
                            <input id="chat-input" class="form-control" placeholder="Type message‚Ä¶">
                            <button id="btn-send" class="btn btn-primary" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-inv">
            <h5 class="mb-3">Pending invites</h5>
            <div id="inv-box">
                <p class="small text-muted text-center">Loading invites...</p>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-me">
            <p><strong>Session username:</strong> <code id="user-slug"></code></p>
            <p><strong>Personal blob:</strong> <a id="blob-link" target="_blank"></a></p>
            <pre id="profile-box" class="bg-dark p-3 rounded small"></pre>
            <button id="btn-logout" class="btn btn-danger mt-3">Logout</button>
        </div>
    </div>
</div>

<!--  MODALS  -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteModalLabel">Send invite</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="slug-invite" class="form-control mb-3" placeholder="Friend's slug">
                <div id="invite-status" class="small text-info"></div>
            </div>
            <div class="modal-footer">
                <button id="btn-invite" class="btn btn-primary">Invite</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="nicknameModal" tabindex="-1" aria-labelledby="nicknameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="nicknameModalLabel">Set Nickname</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nicknameInput" class="form-label">Nickname for this chat:</label>
                    <input type="text" class="form-control" id="nicknameInput" placeholder="e.g. Friend">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNicknameBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!--  SHARE MODAL  -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share your username</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-3"><code id="share-slug"></code></p>
                <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-primary" id="share-copy">Copy</button>
                    <a class="btn btn-success" id="share-email" target="_blank">Email</a>
                    <a class="btn btn-info" id="share-whatsapp" target="_blank">WhatsApp</a>
                </div>
            </div>
        </div>
    </div>
</div>
<!--  /MODALS  -->

<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/libsodium-wrappers/0.5.4/sodium.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dexie@4.0.4/dist/dexie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/automerge@2.3.1/dist/automerge.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module" src="./sha.js"></script>
<script type="module" src="./validator.js"></script>
<script type="module" src="./0knowledge.js"></script>
<script type="module" src="./dapp.js"></script>

<script>
/*  helper pentru schimbarea rapidƒÉ a navbar-ului  */
window.updateNavbarAuth = (username = null, slug = '') => {
    const navAuth     = document.getElementById('nav-auth');
    const navUser     = document.getElementById('nav-user');
    const navUsername = document.getElementById('nav-username');
    const shareSlug   = document.getElementById('share-slug');
    const shareEmail  = document.getElementById('share-email');
    const shareWA     = document.getElementById('share-whatsapp');

    if(username){
        navAuth.classList.add('d-none');
        navUser.classList.remove('d-none');
        navUsername.textContent = '@'+username;
        shareSlug.textContent   = '@'+username;
        shareEmail.href = `mailto:?subject=Add%20me%20on%20Cryptogram&body=My%20username%20is%20${encodeURIComponent(username)}`;
        shareWA.href    = `https://wa.me/?text=${encodeURIComponent('Add me on Cryptogram! My username is '+username)}`;
    }else{
        navAuth.classList.remove('d-none');
        navUser.classList.add('d-none');
    }
};

/*  copy √Æn clipboard  */
document.getElementById('share-copy').addEventListener('click',()=>{
    const txt=document.getElementById('share-slug').textContent;
    navigator.clipboard.writeText(txt).then(()=>{
        const toast=document.createElement('div');
        toast.className='toast align-items-center text-white bg-success border-0';
        toast.role='alert';toast.innerHTML=`<div class="d-flex"><div class="toast-body">Copied!</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        document.getElementById('toast-container').appendChild(toast);
        new bootstrap.Toast(toast).show();
    });
});

/*  naviga»õie rapidƒÉ din navbar  */
document.getElementById('navLoginLink').addEventListener('click',e=>{
    e.preventDefault();
    new bootstrap.Tab(document.querySelector('#auth-tabs [data-bs-target="#tab-log"]')).show();
    document.getElementById('auth-wrap').scrollIntoView({behavior:'smooth'});
});
document.getElementById('navRegLink').addEventListener('click',e=>{
    e.preventDefault();
    new bootstrap.Tab(document.querySelector('#auth-tabs [data-bs-target="#tab-reg"]')).show();
    document.getElementById('auth-wrap').scrollIntoView({behavior:'smooth'});
});

/*  Logout direct din navbar  */
document.getElementById('nav-logout').addEventListener('click',()=>{
    if(window.ok0?.logout) window.ok0.logout().finally(()=>{
        updateNavbarAuth(null);
        location.reload();
    });
});
</script>
</body>
</html>
